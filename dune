(data_only_dirs Normaliz Normaliz-offline)
(include_subdirs unqualified)

(library
  (name	normalizffi)
  (public_name normalizffi)
  (libraries ctypes.foreign gmp)
  ; (foreign_archives normaliz_stubs flint normaliz eanticxx sha256 cocoa)
  (foreign_archives normaliz_stubs flint normaliz nauty)
  ; (link_flags (-cclib "-L./Normaliz-offline/local/lib -lstdc++ -lgmpxx -lgmp -leanticxx -lnormaliz -lflint"))
  ; (foreign_stubs (language cxx)
  ;		 (names normaliz_stub flint_stub)
  ; 		 (include_dirs ./Normaliz-offline/local/include)
  ;		 (flags :standard -Wno-deprecated-declarations --verbose -L./Normaliz-offline/local/lib -lstdc++ -lgmpxx -lgmp -leanticxx -lnormaliz -lflint))
  ; (foreign_archives flint normaliz)
  ; (library_flags (-linkall))
  ; (library_flags (-linkall -cclib "-L./Normaliz-offline/local/lib -lnormaliz -lflint -lgmp -lgmpxx"))
  ; (c_library_flags (-lstdc++ -lgmpxx -lgmp -leanticxx -lnormaliz -lflint -lsha256 -lgomp -lnauty -lcocoa))
  ; (c_library_flags (:standard -lstdc++ -lgmpxx -lgmp -lgomp -l:dllnormaliz.so -l:dllflint.so -l:dlleanticxx.so -l:dllsha256.so -l:dllnauty.so -l:dllcocoa.so))

  ; For Flint, relocation fails because of TLS storage (I think), and the solution is to explicitly link against .so instead of .a.
  ; For Normaliz, we have to compile with -fPIC.
  ; (c_library_flags (-lstdc++ -lgmpxx -lgmp -lgomp -lnormaliz -lflint -leanticxx -lsha256 -lnauty -lcocoa)))
  (c_library_flags (-lstdc++ -lgmpxx -lgmp -lgomp -lnormaliz -lflint -lnauty)))

  ; (flags (-verbose))
  ; (flags (-verbose) (-ccopt -L../../Normaliz-offline/local/lib))
  ; Do foreign_archives manually, but without dllib because it links in libnormaliz.a and libflint.a by default, which are not PIC.
  ; (ocamlopt_flags (-verbose) (-ccopt -L.) (-ccopt -lnormaliz_stubs) (-ccopt -l:dllnormaliz.so) (-ccopt -l:dllflint.so))
  ; (ocamlc_flags (-verbose) (-ccopt -lnormaliz_stubs) (-dllib -l:dllnormaliz.so) (-dllib -l:dllflint.so))

; -dllib -lnormaliz_stubs -cclib -lnormaliz_stubs -cclib -lstdc++ -cclib -lgmpxx -cclib -lgmp -cclib -lgomp -cclib -l:dllnormaliz.so -cclib -l:dllflint.so -cclib -l:dlleanticxx.so -cclib -lsha256 -cclib -lnauty -cclib -lcocoa
; -cclib -lnormaliz_stubs -cclib -lstdc++ -cclib -lgmpxx -cclib -lgmp -cclib -lgomp -cclib -l:dllnormaliz.so -cclib -l:dllflint.so -cclib -l:dlleanticxx.so -cclib -lsha256 -cclib -lnauty -cclib -lcocoa

(foreign_library
  (archive_name normaliz_stubs)
  (language cxx)
  (names normaliz_stub flint_stub)
  (include_dirs ./Normaliz-offline/local/include))
  ; (flags :standard -Wno-deprecated-declarations --verbose -lstdc++ -lgmpxx -lgmp -l:libnormaliz.so -l:libflint.so -l:libeanticxx.so -fPIC -shared)
  ; (flags :standard -Wno-deprecated-declarations --verbose -lstdc++ -lgmpxx -lgmp -l:libnormaliz.so -l:libflint.so -l:libeanticxx.so -fPIC -shared)
  ; (flags :standard -Wno-deprecated-declarations --verbose -lstdc++ -lgmpxx -lgmp -lnormaliz -lflint -leanticxx -fPIC -shared -L./Normaliz-offline/local/lib)
  ; (flags :standard -Wno-deprecated-declarations --verbose -lstdc++ -lgmpxx -lgmp -lnormaliz -lflint -leanticxx -fPIC -shared -L./Normaliz-offline/local/lib)

(rule
  (deps (source_tree Normaliz-offline))
  ; (targets dllnormaliz.so libnormaliz.a dllflint.so libflint.a dlleanticxx.so libeanticxx.a dllsha256.so libsha256.a dllnauty.so libnauty.a dllcocoa.so libcocoa.a)
  ; (targets dllnormaliz.so libnormaliz.a dllflint.so libflint.a dlleanticxx.so libeanticxx.a dllsha256.so libsha256.a libnauty.a dllcocoa.so libcocoa.a)
  (targets dllnormaliz.so libnormaliz.a dllflint.so libflint.a dllnauty.so libnauty.a)
  ; (targets dllnormaliz.so libnormaliz.a dllflint.so libflint.a dlleanticxx.so libeanticxx.a libsha256.a libnauty.a libcocoa.a)
  (action
    (no-infer
      (progn
        ; (chdir Normaliz-offline/local/lib (run %{env:CC=gcc} -shared -fPIC -Wl,--whole-archive -o dllsha256.so -L. -lsha256 -Wl,-no-whole-archive))
        ; (chdir Normaliz-offline/local/lib (run %{env:CC=gcc} -shared -fPIC -Wl,--whole-archive -o dllnauty.so -L. -lnauty -Wl,-no-whole-archive))
        ; (chdir Normaliz-offline/local/lib (run %{env:CC=gcc} -shared -fPIC -Wl,--whole-archive -o dllcocoa.so -L. -lcocoa -Wl,-no-whole-archive))
	; (chdir Normaliz-offline/local/lib (run %{env:CC=gcc} -shared -fPIC -o dllsha256.so -L. -lsha256))
	; (chdir Normaliz-offline/local/lib (run %{env:CC=gcc} -shared -o dllnauty.so -L. -lnauty))
	; (chdir Normaliz-offline/local/lib (run %{env:CC=gcc} -shared -fPIC -o dllcocoa.so -L. -lcocoa))
	; (chdir Normaliz-offline/local/lib (run %{env:CC=gcc} -shared -o dllsha256.so -L. -lsha256))
	(chdir Normaliz-offline/local/lib (run %{env:CC=gcc} -shared -fPIC -o dllnauty.so -L. -lnauty))
	; (chdir Normaliz-offline/local/lib (run %{env:CC=gcc} -shared -o dllcocoa.so -L. -lcocoa))
	; (chdir Normaliz-offline/local/lib (run %{env:CC=gcc} -shared -Wl,--whole-archive -o dllflint.so -L. -lflint -Wl,-no-whole-archive))
	; (chdir Normaliz-offline/local/lib (run %{env:CC=gcc} -shared -Wl,--whole-archive -o dllnormaliz.so -L. -lnormaliz -Wl,-no-whole-archive))
        (copy Normaliz-offline/local/lib/libnormaliz.so dllnormaliz.so)
	; (copy Normaliz-offline/local/lib/libnormaliz.so libnormaliz.so.3)
	; (run ln libnormaliz.so.3 dllnormaliz.so)
        (copy Normaliz-offline/local/lib/libnormaliz.a libnormaliz.a)
        (copy Normaliz-offline/local/lib/libflint.so dllflint.so)
        (copy Normaliz-offline/local/lib/libflint.a libflint.a)
        ; (copy Normaliz-offline/local/lib/libeanticxx.so dlleanticxx.so)
        ; (copy Normaliz-offline/local/lib/libeanticxx.a libeanticxx.a)
        ; (copy Normaliz-offline/local/lib/dllsha256.so dllsha256.so)
        ; (copy Normaliz-offline/local/lib/libsha256.a libsha256.a)
        (copy Normaliz-offline/local/lib/dllnauty.so dllnauty.so)
        (copy Normaliz-offline/local/lib/libnauty.a libnauty.a)))))
        ; (copy Normaliz-offline/local/lib/dllcocoa.so dllcocoa.so)
        ; (copy Normaliz-offline/local/lib/libcocoa.a libcocoa.a)))))

; (install_c_headers normaliz_stub flint_stub stub_common); copy C headers to the installation directory

; (foreign_library
;   (archive_name normaliz)
;   (language cxx)
;   (names normaliz_stub flint_stub)
;   (include_dirs ./Normaliz-offline/include)
;   (flags :standard -Wno-deprecated-declarations --verbose -L./Normaliz-offline/local/lib -lstdc++ -lgmpxx -lgmp -leanticxx -lnormaliz -lflint))

;(executables
;  (names normaliz_stub.o flint.o)
;  (modes (native object)))